name: Flutter CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: 测试和构建
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true
      
      - name: 获取依赖
        run: flutter pub get
        
      - name: 运行代码分析
        run: flutter analyze
      
      - name: 运行单元测试和小部件测试
        run: flutter test --coverage
      
      - name: 上传覆盖率报告
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          
  integration_test:
    name: 集成测试
    runs-on: macos-latest
    strategy:
      matrix:
        device:
          - "iPhone 14"
          - "Pixel 5"
    steps:
      - uses: actions/checkout@v3
      
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true
      
      - name: 获取依赖
        run: flutter pub get
        
      - name: 设置 Xcode (仅iOS)
        if: matrix.device == 'iPhone 14'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: 启动iOS模拟器 (仅iOS)
        if: matrix.device == 'iPhone 14'
        uses: futureware-tech/simulator-action@v3
        with:
          model: 'iPhone 14'
          
      - name: 运行iOS集成测试 (仅iOS)
        if: matrix.device == 'iPhone 14'
        run: flutter test integration_test/app_test.dart -d 'iPhone 14'
      
      - name: 设置Android模拟器 (仅Android)
        if: matrix.device == 'Pixel 5'
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          profile: Pixel 5
          script: flutter test integration_test/app_test.dart -d 'Pixel 5' 